services:
  # --- INSTANCE 1: ETH/BTC ---
  bot_eth:
    build: .
    container_name: ethbtc_bot
    restart: unless-stopped
    networks:
      - default
      - trading-net
    environment:
      - BINANCE_KEY=${SPOT_TESTNET_KEY}
      - BINANCE_SECRET=${SPOT_TESTNET_SECRET}
      - MODE=${MODE}
      - SYMBOL=ETHBTC
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_ETH}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    volumes:
      - ./run_state/eth:/data # Isolated State Folder for ETH
      - .:/app
    command: >
      python /app/live_executor.py  --params configs/prod_meta_live.json  --mode ${MODE}  --symbol ETHBTC --state /data/state.json
    ports:
      - "9109:9109"

  # --- INSTANCE 2: BNB/USDC ---
  # bot_bnb:
  #   build: .
  #   container_name: bnbusdc_bot
  #   restart: unless-stopped
  #   networks:
  #     - default  
  #     - trading-net
  #   environment:
  #     - BINANCE_KEY=${BINANCE_KEY}
  #     - BINANCE_SECRET=${BINANCE_SECRET}
  #     - BINANCE_BASE_URL=${BINANCE_BASE_URL}
  #     - MODE=${MODE}
  #     - SYMBOL=BNBUSDC
  #     - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
  #     - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
  #     - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
  #   volumes:
  #     - ./run_state/bnb:/data  # Isolated State Folder for BNB
  #     - .:/app
  #   command: >
  #     python /app/live_executor.py 
  #     --params configs/prod_bnb_meta_live.json 
  #     --mode ${MODE} 
  #     --symbol BNBUSDC
  #     --state /data/state.json
  #   ports:
  #     - "9101:9109" # Maps Host 9101 -> Container 9109

  bot_btc:
    build: .
    container_name: btcusdt_bot
    restart: unless-stopped
    environment:
      - BINANCE_KEY=${FUTURES_TESTNET_KEY}
      - BINANCE_SECRET=${FUTURES_TESTNET_SECRET}
      - MODE=${MODE}
      - SYMBOL=BTCUSDT
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_BTC}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    volumes:
      - ./run_state/btc:/data
      - .:/app
    command: >
      python /app/live_executor.py  --params configs/prod_btc_meta_live.json  --mode ${MODE}  --symbol BTCUSDT --state /data/state.json
    ports:
      - "9102:9109"
    networks:
      - default
      - trading-net

  # --- UTILITIES ---
  sweeper:
    build: .
    container_name: global_sweeper
    restart: unless-stopped
    environment:
      - BINANCE_KEY=${BINANCE_KEY}
      - BINANCE_SECRET=${BINANCE_SECRET}
      - BINANCE_BASE_URL=${BINANCE_BASE_URL}
      - MODE=${MODE}
      - SWEEPER_IGNORE=${SWEEPER_IGNORE}
    volumes:
      - .:/app
    command: python /app/tools/dust_sweeper.py --mode auto --schedule weekly

  # pnl_reconciler:
  #   build: .    
  #   command: ["python", "tools/reconcile_pnl_daemon.py"]
  #   restart: unless-stopped
  #   environment:
  #     - BINANCE_KEY=${FUTURES_TESTNET_KEY}
  #     - BINANCE_SECRET=${FUTURES_TESTNET_SECRET}
  #     - MODE=${MODE}
  #     - SYMBOL=BTCUSDT
  #     - BINANCE_BASE_URL=${BINANCE_BASE_URL:-https://api.binance.com}
  #     - STATE_FILE=/data/state_live.json
  #     - ALERT_WEBHOOK=${ALERT_WEBHOOK}           
  #     # Optional: override interval (seconds)
  #     # - PNL_RECONCILE_INTERVAL_SEC=14400
  #   volumes:
  #     # Needs to see the botâ€™s state.json
  #     - ./data:/data
  #   depends_on:
  #     - bot_eth

  # optimizer:
  #     build: .
  #     command: ["python", "tools/monthly_optimizer.py"]
  #     restart: unless-stopped
  #     environment:
  #       - SYMBOL=ETHBTC
  #       - OPT_INTERVALS=15m
  #       - RAW_OUT_DIR=data/raw
  #       - RUN_COMPLETE_SCRIPT=run_complete_optimization.sh
  #       - SUGGESTED_CONFIG=configs/prod_meta_live_suggested.json
  #       - MONTHLY_OPT_POLL_SEC=21600    # 6h poll
  #       - ALERT_WEBHOOK=${ALERT_WEBHOOK}
  #       # re-use whatever env your optimizer script needs
  #     volumes:
  #       - ./data:/data          # for raw CSV and state
  #       - ./configs:/configs    # optional if you keep configs there
  #       - .:/app                # or however your code is mounted in other services
  #     depends_on:
  #       - bot_eth

  # --- OBSERVABILITY STACK (Fixed) ---
  prometheus:
    image: prom/prometheus:latest
    container_name: ethbtc_prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9999:9090"
    networks:
      - trading-net

  grafana:
    image: grafana/grafana:latest
    container_name: ethbtc_grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - trading-net

  watchtower:
    image: containrrr/watchtower
    container_name: global_watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      # Optional: Send notifications when updates happen
      # - WATCHTOWER_NOTIFICATION_URL=${DISCORD_WEBHOOK_URL} 
    networks:
      - trading-net

# Ensure volumes are defined at the bottom of the file
volumes:
  prometheus_data:
  grafana_data:


networks:
  trading-net:
    external: true
